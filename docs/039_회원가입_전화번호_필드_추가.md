# 회원가입 전화번호 필드 추가

## 📋 작업 개요

회원가입 프로세스에 전화번호(phone) 필드를 필수로 추가하는 작업입니다.

- **작업 일자**: 2025-11-13
- **담당자**: Claude Code
- **목표**: 회원가입 시 전화번호를 필수 입력하도록 하며, xxx-xxxx-xxxx 형식으로 자동 포맷팅

## 🎯 요구사항

1. **전화번호 필드 추가**
   - 형식: `xxx-xxxx-xxxx` (예: 010-1234-5678)
   - 필수 입력 (NOT NULL)
   - 인증 없음 (입력만 받음)
   - 숫자만 입력받고 자동으로 하이픈 삽입

2. **데이터 흐름**
   - 회원가입 요청 → auth.users에 options로 name, organization, phone 전달
   - 이메일 인증 완료 → trigger 동작 → public.users에 행 추가
   - raw_user_meta_data에 저장된 name, organization, phone이 public.users에 삽입

## 📝 변경 사항

### 1. 데이터베이스 마이그레이션

#### 파일: `supabase/migrations/20251113000000_add_phone_to_users.sql`
```sql
-- users 테이블에 phone 컬럼 추가
ALTER TABLE public.users
ADD COLUMN phone TEXT;

-- 전화번호 형식 검증 제약조건 추가 (xxx-xxxx-xxxx 형식)
ALTER TABLE public.users
ADD CONSTRAINT check_phone_format
CHECK (phone IS NULL OR phone ~ '^\d{3}-\d{4}-\d{4}$');

-- 컬럼 주석 추가
COMMENT ON COLUMN public.users.phone IS '전화번호 (형식: xxx-xxxx-xxxx)';
```

#### 파일: `supabase/migrations/20251113010000_update_handle_new_user_phone.sql`
```sql
-- handle_new_user 함수 수정 (phone 필드 추가)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  -- public.users 테이블에 레코드 생성
  INSERT INTO public.users (id, name, email, organization, phone, role, is_approved)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'name', 'User' || EXTRACT(EPOCH FROM NOW())::BIGINT::TEXT),
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'organization', NULL),
    COALESCE(NEW.raw_user_meta_data->>'phone', NULL),
    'member',
    NULL  -- 승인 대기 상태
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### 파일: `supabase/migrations/20251113020000_make_phone_required.sql`
```sql
-- phone 컬럼을 필수 필드로 변경

-- 1. 기존 NULL 값을 기본값으로 업데이트
UPDATE public.users SET phone = '010-0000-0000' WHERE phone IS NULL;

-- 2. 기존 check_phone_format 제약조건 삭제
ALTER TABLE public.users
DROP CONSTRAINT IF EXISTS check_phone_format;

-- 3. NULL을 허용하지 않는 새로운 check_phone_format 제약조건 추가
ALTER TABLE public.users
ADD CONSTRAINT check_phone_format
CHECK (phone ~ '^\d{3}-\d{4}-\d{4}$');

-- 4. phone 컬럼에 NOT NULL 제약조건 추가
ALTER TABLE public.users
ALTER COLUMN phone SET NOT NULL;

-- 5. 컬럼 주석 업데이트
COMMENT ON COLUMN public.users.phone IS '전화번호 (형식: xxx-xxxx-xxxx, 필수)';
```

### 2. TypeScript 타입 정의

#### 파일: `types/database.type.ts`
- Supabase CLI로 타입 자동 생성: `npx supabase gen types typescript --local > types/database.type.ts`
- `users` 테이블 타입에 `phone: string` 추가됨

### 3. 백엔드 코드 수정

#### 파일: `lib/supabase/auth.ts`
- `signUpUser` 함수 파라미터에 `phone: string` 추가
- `options.data`에 `phone` 포함

```typescript
export async function signUpUser(
  supabase: SupabaseClient<Database>,
  data: {
    email: string
    password: string
    name: string
    organization: string
    phone: string  // 추가
  }
): Promise<AuthResponse<null>> {
  try {
    const { error: authError } = await supabase.auth.signUp({
      email: data.email,
      password: data.password,
      options: {
        data: {
          name: data.name,
          organization: data.organization,
          phone: data.phone,  // 추가
        },
      },
    })
    // ...
  }
}
```

#### 파일: `app/api/auth/signup/route.ts`
- 요청 body에서 `phone` 추출
- 필수 필드 검증에 `phone` 추가
- 전화번호 형식 검증 (`/^\d{3}-\d{4}-\d{4}$/`)
- `signUpUser()` 호출 시 `phone` 전달

```typescript
const { email, password, name, organization, phone } = body

// 입력 데이터 검증
if (!email || !password || !name || !organization || !phone) {
  return NextResponse.json(
    {
      success: false,
      data: null,
      error: { errorMessage: '모든 필드를 입력해주세요.' },
    },
    { status: 400 }
  )
}

// 전화번호 검증 (xxx-xxxx-xxxx 형식)
const phoneRegex = /^\d{3}-\d{4}-\d{4}$/
if (!phoneRegex.test(phone)) {
  return NextResponse.json(
    {
      success: false,
      data: null,
      error: {
        errorMessage: '전화번호는 xxx-xxxx-xxxx 형식이어야 합니다.',
      },
    },
    { status: 400 }
  )
}
```

### 4. 프론트엔드 코드 수정

#### 파일: `components/auth/SignupForm.tsx`

**Zod 스키마에 phone 필드 추가:**
```typescript
const signupSchema = z
  .object({
    // ... 기존 필드들 ...
    phone: z
      .string()
      .regex(/^\d{3}-\d{4}-\d{4}$/, '전화번호는 xxx-xxxx-xxxx 형식이어야 합니다')
      .min(13, '전화번호를 정확히 입력해주세요'),
    // ...
  })
```

**전화번호 입력 필드 추가:**
```tsx
<FormField
  control={form.control}
  name="phone"
  render={({ field }) => (
    <FormItem>
      <FormLabel className="text-foreground">전화번호</FormLabel>
      <FormControl>
        <Input
          type="tel"
          placeholder="010-1234-5678"
          {...field}
          onChange={(e) => {
            // 숫자만 추출
            const numbers = e.target.value.replace(/[^\d]/g, '')
            // 자동 하이픈 삽입 (xxx-xxxx-xxxx)
            let formatted = numbers
            if (numbers.length > 3) {
              formatted = numbers.slice(0, 3) + '-' + numbers.slice(3)
            }
            if (numbers.length > 7) {
              formatted =
                numbers.slice(0, 3) +
                '-' +
                numbers.slice(3, 7) +
                '-' +
                numbers.slice(7, 11)
            }
            field.onChange(formatted)
          }}
          maxLength={13}
        />
      </FormControl>
      <FormMessage />
    </FormItem>
  )}
/>
```

**onSubmit 함수 수정:**
```typescript
body: JSON.stringify({
  email: data.email,
  password: data.password,
  name: data.name,
  organization: data.organization,
  phone: data.phone,  // 추가
}),
```

### 5. 문서 업데이트

#### 파일: `DATABASE_SCHEMA.md`
- `users` 테이블 스키마에 `phone TEXT NOT NULL` 추가
- `check_phone_format` 제약조건 추가
- `handle_new_user` 함수 정의 업데이트 (phone 필드 포함)

## ✅ 검증 사항

### 1. 클라이언트 측 검증
- [ ] 전화번호 없이 회원가입 시도 → 오류 메시지 표시
- [ ] 잘못된 형식 입력 (예: 12345, abc-defg-hijk) → 클라이언트 검증 실패
- [ ] 숫자만 입력 시 자동 하이픈 삽입
  - `010` → `010-`
  - `01012` → `010-12`
  - `01012345678` → `010-1234-5678`
- [ ] 최대 13자(하이픈 포함) 제한 동작 확인

### 2. 서버 측 검증
- [ ] 전화번호 없이 API 호출 → 400 에러 반환
- [ ] 잘못된 형식 API 호출 → 400 에러 및 오류 메시지 반환
- [ ] 올바른 형식으로 회원가입 → 성공 응답

### 3. 데이터베이스 검증
- [ ] 이메일 인증 완료 후 `public.users.phone`에 데이터 저장 확인
- [ ] `check_phone_format` 제약조건 동작 확인
- [ ] `NOT NULL` 제약조건 동작 확인

### 4. 통합 테스트
- [ ] 회원가입 전체 플로우 테스트
  1. 폼 입력 (전화번호 포함)
  2. 자동 하이픈 삽입 확인
  3. 회원가입 요청
  4. 이메일 인증
  5. public.users 테이블에 phone 데이터 저장 확인

## 🔍 Playwright 테스트 시나리오

### 테스트 1: 정상 회원가입
1. 회원가입 페이지 접속
2. 전화번호 필드에 숫자만 입력 (01012345678)
3. 자동으로 010-1234-5678 형식으로 변환되는지 확인
4. 모든 필드 입력 후 회원가입 버튼 클릭
5. 성공 메시지 확인

### 테스트 2: 전화번호 없이 회원가입
1. 회원가입 페이지 접속
2. 전화번호를 제외한 모든 필드 입력
3. 회원가입 버튼 클릭
4. "전화번호를 정확히 입력해주세요" 오류 메시지 표시 확인

### 테스트 3: 잘못된 형식 입력
1. 회원가입 페이지 접속
2. 전화번호 필드에 잘못된 형식 입력 (예: 12345)
3. 오류 메시지 표시 확인
4. 숫자만 입력하면 자동으로 하이픈 삽입되는지 확인

## 📌 주의사항

1. **마이그레이션 순서**
   - 반드시 순서대로 실행: `20251113000000` → `20251113010000` → `20251113020000`
   - 기존 사용자가 있는 경우 `20251113020000`에서 기본값(`010-0000-0000`)으로 업데이트됨

2. **기존 사용자 처리**
   - 마이그레이션 `20251113020000`에서 기존 NULL 값을 `010-0000-0000`으로 자동 업데이트
   - 필요시 관리자가 수동으로 실제 전화번호로 업데이트 필요

3. **프론트엔드 입력 제어**
   - `maxLength={13}`으로 최대 입력 길이 제한
   - 숫자만 입력받고 하이픈은 자동 삽입
   - 사용자가 하이픈을 입력해도 무시됨

4. **서버 측 검증 이중화**
   - 클라이언트(Zod)와 서버(API Route) 양쪽에서 검증
   - 데이터베이스 제약조건(`check_phone_format`)도 설정하여 3중 보호

## 🚀 배포 체크리스트

- [ ] 로컬 환경에서 마이그레이션 테스트
- [ ] TypeScript 타입 생성 (`npx supabase gen types typescript --local`)
- [ ] 로컬 환경에서 회원가입 테스트
- [ ] Playwright 테스트 실행 및 통과 확인
- [ ] Supabase 프로덕션 환경에 마이그레이션 적용
- [ ] 프로덕션 환경에서 회원가입 테스트
- [ ] 기존 사용자 전화번호 업데이트 필요 여부 확인

## 📖 참고 문서

- [DATABASE_SCHEMA.md](../DATABASE_SCHEMA.md)
- [PRD.md](../PRD.md)

---

**작업 완료일**: 2025-11-13
**최종 검토자**: -
