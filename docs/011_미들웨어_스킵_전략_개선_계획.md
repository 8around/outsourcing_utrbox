## 미들웨어 스킵 전략 개선 계획

### 배경/문제

- 현재 `middleware.ts`에서 미들웨어 스킵이 이중으로 관리됨
  - `export const config.matcher`에서 1차 필터
  - `middleware()` 함수 내부에서 `/_next`, `/api`, `.` 포함 여부로 2차 필터
- `pathname.includes('.')` 검사는 정적 루트 파일(예: `/robots.txt`)을 우회시키려는 의도로 보이나, 이로 인해 필터 중복/불일치가 발생
- `publicPaths`에 `'/'`가 포함되어 있어 비로그인 사용자가 루트 접근 시 `app/page.tsx`의 Next 기본 안내 페이지가 노출됨 (의도와 불일치)

### 목표

- 스킵 대상 정의를 `config.matcher` 한 곳에서만 관리하여 중복 제거 및 일관성 확보
- 모든 확장자 요청(정적 파일 등)을 `matcher`에서 배제해 내부 `.` 검사 제거
- 루트(`/`) 접근 시 의도한 UX(로그인/대시보드 리디렉션) 보장

### 변경 사항 개요

1. `config.matcher` 정비: 정적/이미지/파비콘/API/확장자 요청 전체 제외
2. `middleware()` 내부 스킵 블록 제거 (중복 로직 삭제)
3. `publicPaths`에서 `'/'` 제거 및 루트 전용 리디렉션 추가
4. 부수 정리: 사용되지 않는 `protectedPaths` 제거(선택)

### 상세 변경 계획

#### 1) `config.matcher` 개선

- 목적: 정적 파일과 API 및 모든 확장자 요청을 미들웨어 실행 대상에서 제외
- 변경안:

```ts
export const config = {
  matcher: [
    // api, _next/*, favicon 등과 "확장자 있는 모든 파일 요청"을 제외
    '/((?!api|_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml|site.webmanifest|manifest.webmanifest|.*\\..*).*)',
  ],
}
```

- 비고: Next의 `public` 폴더 파일은 실제 요청 경로에 `public`이 포함되지 않으므로 `public` 키워드 예외는 의미가 없습니다. 확장자 패턴(`.*\\..*`)으로 일괄 제외합니다.

#### 2) 내부 스킵 블록 제거

- 목적: 실행 여부는 `matcher`에서만 결정되도록 단일화
- 삭제 대상(예):

```ts
// 정적 파일 및 API 경로는 미들웨어 건너뛰기
if (pathname.startsWith('/_next') || pathname.startsWith('/api') || pathname.includes('.')) {
  return NextResponse.next()
}
```

#### 3) 루트 처리 및 공개 경로 정리

- `publicPaths`에서 `'/'` 제거:

```ts
const publicPaths = ['/login', '/signup', '/reset-password']
```

- 루트 전용 리디렉션 추가:

```ts
if (pathname === '/') {
  return NextResponse.redirect(new URL(user ? '/dashboard' : '/login', request.url))
}
```

- 로그인 사용자가 인증 페이지 접근 시 대시보드로 리디렉션하는 기존 로직은 유지

#### 4) 승인 대기 사용자 흐름 점검(옵션)

- 현재 구조에서도 `/dashboard` 진입 시 승인 체크로 `/pending-approval`로 유도 가능
- 필요 시 루트 리디렉션을 프로필 조회 이후로 이동하여 루트에서도 직접 `/pending-approval`로 보낼 수 있음

### 적용 순서

1. `middleware.ts`의 `config.matcher`를 위 패턴으로 갱신
2. `middleware()` 내부 스킵 블록(특히 `pathname.includes('.')`) 제거
3. `publicPaths`에서 `'/'` 삭제 후 루트 리디렉션 추가
4. (선택) 사용하지 않는 `protectedPaths` 제거

### 검증 시나리오

- 비로그인 사용자
  - `/` → `/login`으로 리디렉션
  - `/login` → 통과, 페이지 렌더
  - `/dashboard` → `/login`으로 리디렉션
- 로그인 사용자(승인됨)
  - `/` → `/dashboard`로 리디렉션
  - `/login` 또는 `/signup` → `/dashboard`로 리디렉션
  - `/admin/*` → 역할이 `Admin`이 아니면 `/dashboard`로 리디렉션
- 승인 대기 사용자
  - `/dashboard` 접근 시 `/pending-approval`로 리디렉션(현행 로직 유지)
- 정적/확장자 요청
  - `/robots.txt`, `/favicon.ico`, `/images/logo.png` 등은 미들웨어 미실행
- API 요청
  - `/api/*`는 미들웨어 미실행(각 API 라우트에서 별도 인증 처리 필요)

### 리스크/주의사항

- API 라우트 보호 필요 시, API 라우트 내부에서 서버 사이드 인증 검증을 구현해야 함
- 라우트에 점(`.`)을 포함하는 커스텀 경로 설계 시, `matcher`의 `.*\\..*` 예외에 의해 미들웨어가 실행되지 않을 수 있음(일반적으로 경로에 점 포함은 비권장)

### 참고 파일

- `middleware.ts`
- `lib/supabase/middleware.ts`
- `app/page.tsx` (루트 페이지: 기본 템플릿 노출 방지 목적의 리디렉션 추가와 관계)
