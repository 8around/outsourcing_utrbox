# 030. 사용자 콘텐츠 관리 페이지 컬렉션 기능 추가

## 📋 개요

관리자가 특정 사용자의 콘텐츠를 조회할 때 컬렉션별로 필터링할 수 있도록 하고, 각 콘텐츠가 속한 컬렉션을 테이블에 표시하는 기능을 추가합니다.

기존에 `components/admin/users/UserContentToolbar.tsx`를 `components/explorer/ExplorerToolbar.tsx`를 기반으로 생성했으나, 컬렉션 선택 기능이 누락되었습니다. 이번 작업에서는 컬렉션 선택 기능을 추가하되, **컬렉션 생성 버튼은 제외**합니다 (관리자는 사용자의 컬렉션을 생성할 수 없음).

## 🎯 작업 목표

1. **UserContentToolbar**: 컬렉션 선택 드롭다운 추가 (생성 버튼 제외)
2. **getUserContentsWithPagination API**: 컬렉션 ID 필터 파라미터 추가
3. **UserContentTable**: 컬렉션 이름을 표시하는 열 추가
4. **page.tsx**: 컬렉션 상태 관리 및 필터링 로직 통합

## 📁 작업 대상 파일

```
components/admin/users/
├── UserContentToolbar.tsx    # 컬렉션 선택 추가
└── UserContentTable.tsx       # 컬렉션 열 추가

lib/api/
└── contents.ts                # getUserContentsWithPagination 수정

app/admin/users/[id]/
└── page.tsx                   # 상태 관리 및 통합
```

## 🔧 상세 작업 내역

### Phase 1: API 레이어 수정

#### Task 1.1: getUserContentsWithPagination에 컬렉션 필터 추가

**파일**: `lib/api/contents.ts`

**목적**: 특정 컬렉션의 콘텐츠만 조회할 수 있도록 필터 파라미터 추가

**변경사항**:
- `params` 인터페이스에 `collection_id?: string | null` 추가
- `collection_id`가 제공되면 해당 컬렉션의 콘텐츠만 필터링
- `collection_id`가 null이면 전체 콘텐츠 조회

```typescript
export async function getUserContentsWithPagination(
  userId: string,
  params: {
    page?: number
    pageSize?: number
    is_analyzed?: boolean | null
    search?: string
    sortBy?: 'name' | 'date'
    sortOrder?: 'asc' | 'desc'
    collection_id?: string | null  // 🆕 추가
  } = {}
): Promise<PaginatedApiResponse<Content[]>> {
  try {
    const {
      page = 1,
      pageSize = 10,
      is_analyzed,
      search,
      sortBy = 'date',
      sortOrder = 'desc',
      collection_id,  // 🆕 추가
    } = params

    // 기본 쿼리
    let query = supabase
      .from('contents')
      .select(
        `
        *,
        collections(name)
      `,
        { count: 'exact' }
      )
      .eq('user_id', userId)

    // 🆕 컬렉션 필터 적용
    if (collection_id !== undefined && collection_id !== null) {
      query = query.eq('collection_id', collection_id)
    }

    // ... 나머지 로직 동일 ...
  }
}
```

**의존성**: 없음

---

### Phase 2: Toolbar 컴포넌트 수정

#### Task 2.1: UserContentToolbar에 컬렉션 선택 추가

**파일**: `components/admin/users/UserContentToolbar.tsx`

**목적**: 사용자의 컬렉션 목록을 드롭다운으로 표시하고 선택할 수 있게 함

**변경사항**:
1. Props에 컬렉션 관련 항목 추가:
   - `collections: Collection[]` - 사용자의 컬렉션 목록
   - `selectedCollectionId: string | null` - 현재 선택된 컬렉션 ID
   - `onCollectionChange: (collectionId: string | null) => void` - 컬렉션 변경 핸들러

2. UI 구성:
   - `CollectionSelect` 컴포넌트 재사용 (생성 버튼 제거)
   - "모든 컨텐츠" 옵션 (null 값)
   - 사용자의 컬렉션 목록 표시

```typescript
import { Collection } from '@/types/collection'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Folder } from 'lucide-react'
import { ScrollArea } from '@/components/ui/scroll-area'

interface UserContentToolbarProps {
  searchQuery: string
  sortBy: 'name' | 'date'
  sortOrder: 'asc' | 'desc'
  collections: Collection[]  // 🆕 추가
  selectedCollectionId: string | null  // 🆕 추가
  onSearchChange: (query: string) => void
  onSortByChange: (sortBy: 'name' | 'date') => void
  onSortOrderToggle: () => void
  onCollectionChange: (collectionId: string | null) => void  // 🆕 추가
}

export function UserContentToolbar({
  searchQuery,
  sortBy,
  sortOrder,
  collections,  // 🆕 추가
  selectedCollectionId,  // 🆕 추가
  onSearchChange,
  onSortByChange,
  onSortOrderToggle,
  onCollectionChange,  // 🆕 추가
}: UserContentToolbarProps) {
  return (
    <div className="rounded-xl border bg-background shadow">
      <div className="p-4">
        <div className="flex flex-wrap items-center gap-4">
          {/* 🆕 컬렉션 선택 (생성 버튼 제외) */}
          <Select
            value={selectedCollectionId || 'all'}
            onValueChange={(val) => {
              onCollectionChange(val === 'all' ? null : val)
            }}
          >
            <SelectTrigger className="w-[200px]">
              <SelectValue placeholder="모든 컨텐츠" />
            </SelectTrigger>
            <SelectContent>
              {/* 모든 컨텐츠 옵션 */}
              <SelectItem value="all">
                <div className="flex items-center">
                  <Folder className="mr-2 h-4 w-4" />
                  모든 컨텐츠
                </div>
              </SelectItem>

              {/* 컬렉션 목록 */}
              {collections.length > 0 && (
                <ScrollArea className="max-h-[300px]">
                  {collections.map((collection) => (
                    <SelectItem key={collection.id} value={collection.id}>
                      <div className="flex items-center">
                        <Folder className="mr-2 h-4 w-4" />
                        {collection.name}
                      </div>
                    </SelectItem>
                  ))}
                </ScrollArea>
              )}
            </SelectContent>
          </Select>

          {/* 기존 검색 */}
          <div className="relative flex-1 min-w-[200px]">
            {/* ... 기존 코드 ... */}
          </div>

          {/* 기존 정렬 */}
          <div className="flex gap-2">
            {/* ... 기존 코드 ... */}
          </div>
        </div>
      </div>
    </div>
  )
}
```

**의존성**: Task 1.1 완료 후 진행 (API 먼저 준비)

**주의사항**:
- 생성 버튼을 포함하지 않음 (관리자는 사용자의 컬렉션 생성 불가)
- `CollectionSelect` 컴포넌트를 재사용하지 않고 직접 구현 (생성 버튼 제외 버전)

---

### Phase 3: Table 컴포넌트 수정

#### Task 3.1: UserContentTable에 컬렉션 열 추가

**파일**: `components/admin/users/UserContentTable.tsx`

**목적**: 각 콘텐츠가 속한 컬렉션 이름을 테이블에 표시

**변경사항**:
1. 테이블 열 구성 변경:
   - 기존: 이미지 | 파일명 | 분석 상태 | 발견 건수 | 업로드일 (5열)
   - 변경: 이미지 | 파일명 | **컬렉션** | 분석 상태 | 발견 건수 | 업로드일 (6열)

2. 컬렉션 열 구현:
   - `content.collection_name` 표시
   - 컬렉션이 없는 경우 "-" 표시
   - Badge 컴포넌트로 스타일링 (회색)

```typescript
export function UserContentTable({
  contents,
  totalCount,
  currentPage,
  pageSize,
  loading,
  onPageChange,
}: UserContentTableProps) {
  // ... 기존 코드 ...

  return (
    <div className="space-y-4">
      {/* 테이블 */}
      <div className="overflow-x-auto rounded-lg border bg-white">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>이미지</TableHead>
              <TableHead>파일명</TableHead>
              <TableHead className="text-center">컬렉션</TableHead>  {/* 🆕 추가 */}
              <TableHead className="text-center">분석 상태</TableHead>
              <TableHead className="text-center">발견 건수</TableHead>
              <TableHead className="text-right">업로드일</TableHead>
            </TableRow>
          </TableHeader>
          {loading ? (
            <TableBody>
              {/* ... skeleton loading ... */}
            </TableBody>
          ) : (
            <TableBody>
              {contents.length > 0 ? (
                contents.map((content) => (
                  <TableRow
                    key={content.id}
                    className="cursor-pointer hover:bg-gray-50"
                    onClick={() => router.push(`/admin/contents/${content.id}`)}
                  >
                    {/* 이미지 */}
                    <TableCell>{/* ... 기존 코드 ... */}</TableCell>

                    {/* 파일명 */}
                    <TableCell>{/* ... 기존 코드 ... */}</TableCell>

                    {/* 🆕 컬렉션 */}
                    <TableCell className="text-center">
                      {content.collection_name ? (
                        <Badge variant="outline" className="truncate max-w-[150px]">
                          {content.collection_name}
                        </Badge>
                      ) : (
                        <span className="text-gray-400">-</span>
                      )}
                    </TableCell>

                    {/* 분석 상태 */}
                    <TableCell className="text-center">{/* ... 기존 코드 ... */}</TableCell>

                    {/* 발견 건수 */}
                    <TableCell className="text-center">{/* ... 기존 코드 ... */}</TableCell>

                    {/* 업로드일 */}
                    <TableCell className="text-right">{/* ... 기존 코드 ... */}</TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={6} className="h-24 text-center text-gray-500">  {/* colspan 5→6 */}
                    업로드한 콘텐츠가 없습니다.
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          )}
        </Table>
      </div>

      {/* 페이지네이션 */}
      {/* ... 기존 코드 ... */}
    </div>
  )
}
```

**의존성**: Task 1.1 완료 후 진행 (API가 collection_name 반환해야 함)

**주의사항**:
- `content.collection_name`은 이미 API에서 JOIN으로 제공됨 (기존 구현 확인)
- skeleton loading 시 `colSpan`도 6으로 변경 필요
- 빈 상태 메시지 `colSpan`도 6으로 변경 필요

---

### Phase 4: 페이지 통합

#### Task 4.1: page.tsx에 컬렉션 상태 및 로직 통합

**파일**: `app/admin/users/[id]/page.tsx`

**목적**: 컬렉션 목록을 불러오고, 선택된 컬렉션에 따라 콘텐츠를 필터링

**변경사항**:

1. **상태 추가**:
```typescript
const [collections, setCollections] = useState<Collection[]>([])
const [selectedCollectionId, setSelectedCollectionId] = useState<string | null>(null)
```

2. **useEffect 추가 (컬렉션 목록 로드)**:
```typescript
// 컬렉션 목록 불러오기
useEffect(() => {
  if (!user) return

  const loadCollections = async () => {
    const response = await getCollections(user.id, 'name', 'asc')
    if (response.success && response.data) {
      setCollections(response.data)
    }
  }

  loadCollections()
}, [user])
```

3. **fetchContents useEffect 수정** (collection_id 필터 추가):
```typescript
useEffect(() => {
  if (!user) return

  const loadContents = async () => {
    setContentsLoading(true)
    try {
      const response = await getUserContentsWithPagination(user.id, {
        page: contentFilters.page,
        pageSize: 10,
        search: contentFilters.search,
        sortBy: contentFilters.sortBy,
        sortOrder: contentFilters.sortOrder,
        collection_id: selectedCollectionId,  // 🆕 추가
      })

      if (response.success && response.data) {
        setContents(response.data)
        setTotalCount(response.totalCount)
      }
    } finally {
      setContentsLoading(false)
    }
  }

  loadContents()
}, [user, contentFilters, selectedCollectionId])  // 🆕 의존성 추가
```

4. **컬렉션 변경 핸들러 추가**:
```typescript
const handleCollectionChange = (collectionId: string | null) => {
  setSelectedCollectionId(collectionId)
  setContentFilters((prev) => ({ ...prev, page: 1 }))  // 페이지를 1로 리셋
}
```

5. **UserContentToolbar props 추가**:
```typescript
<UserContentToolbar
  searchQuery={contentFilters.search}
  sortBy={contentFilters.sortBy}
  sortOrder={contentFilters.sortOrder}
  collections={collections}  // 🆕 추가
  selectedCollectionId={selectedCollectionId}  // 🆕 추가
  onSearchChange={handleSearchChange}
  onSortByChange={handleSortByChange}
  onSortOrderToggle={handleSortOrderToggle}
  onCollectionChange={handleCollectionChange}  // 🆕 추가
/>
```

6. **Import 추가**:
```typescript
import { Collection } from '@/types/collection'
import { getCollections } from '@/lib/api/collections'
```

**의존성**: Task 1.1, 2.1, 3.1 완료 후 진행

**주의사항**:
- 컬렉션 변경 시 페이지를 1로 리셋하여 혼란 방지
- `selectedCollectionId`가 변경되면 자동으로 콘텐츠 재조회

---

## 📊 작업 순서 및 의존성

```
Task 1.1 (API 수정)
    ↓
Task 2.1 (Toolbar) ← Task 3.1 (Table)
    ↓                     ↓
    └──────→ Task 4.1 (통합) ←──────┘
```

**최적 작업 순서**:
1. Task 1.1 (API 레이어)
2. Task 2.1, 3.1 (병렬 가능)
3. Task 4.1 (통합 및 테스트)

## ✅ 완료 확인 사항

### API 테스트
- [ ] `collection_id` 파라미터로 필터링 정상 작동
- [ ] `collection_id`가 null일 때 전체 조회
- [ ] `collection_name`이 응답에 포함됨

### UI 테스트
- [ ] 컬렉션 드롭다운에 사용자의 컬렉션 목록 표시
- [ ] "모든 컨텐츠" 선택 시 전체 콘텐츠 표시
- [ ] 특정 컬렉션 선택 시 해당 컬렉션의 콘텐츠만 표시
- [ ] 컬렉션 변경 시 페이지가 1로 리셋됨
- [ ] 테이블에 컬렉션 열이 정상 표시됨
- [ ] 컬렉션이 없는 콘텐츠는 "-" 표시

### 통합 테스트
- [ ] 컬렉션 선택 + 검색 + 정렬 조합 동작
- [ ] 로딩 상태가 올바르게 표시됨
- [ ] 페이지네이션 정상 작동

## 🔄 Rollback 방안

각 Task는 개별 파일을 수정하므로 git에서 해당 파일만 revert하면 됩니다:

```bash
# Task 1.1 rollback
git checkout HEAD -- lib/api/contents.ts

# Task 2.1 rollback
git checkout HEAD -- components/admin/users/UserContentToolbar.tsx

# Task 3.1 rollback
git checkout HEAD -- components/admin/users/UserContentTable.tsx

# Task 4.1 rollback
git checkout HEAD -- app/admin/users/[id]/page.tsx
```

## 📝 참고사항

### 왜 컬렉션 생성 버튼을 제외하는가?
- 관리자는 **읽기 전용**으로 사용자의 데이터를 조회만 할 수 있어야 함
- 사용자의 컬렉션을 관리자가 생성/수정/삭제하는 것은 권한 침해
- 컬렉션은 사용자가 직접 자신의 탐색기 페이지에서 관리해야 함

### Content의 collection_id vs collections_contents
- 현재 DB 스키마에서 `contents` 테이블은 `collection_id` 컬럼을 가짐 (1:N 관계)
- JOIN 시 `collections(name)`으로 컬렉션 이름을 가져옴
- 다중 컬렉션 지원이 필요한 경우 추후 `collections_contents` 중간 테이블 사용 고려

### 기존 구현 활용
- `getCollections` API 함수 재사용
- `collection_name`은 이미 `getUserContentsWithPagination`에서 JOIN으로 제공 중
- UI 패턴은 `ExplorerToolbar`의 `CollectionSelect` 로직 참고

---

**작성일**: 2025-01-04
**작성자**: Claude
**관련 문서**: 029_회원_상세_페이지_실제_데이터_연동_및_UI_개선.md
