# 008_쿠키_기반_인증_문제_해결_및_개선_계획

## 📋 개요

**작성일**: 2025-10-25
**목적**: Supabase SSR 쿠키 기반 인증 구현 시 발생한 문제 분석 및 해결 방안 제시
**이전 문서**: 005, 006, 007 계획 문서 실행 후 발생한 문제 해결

---

## 🔴 문제 현상

### 현재 발생 중인 문제들

1. **쿠키가 브라우저에 저장되지 않음**
   - 로그인 후 쿠키가 생성되지 않음

2. **로그인 페이지 접근 시 세션 소실**
   - 로그인 후 `/login` 페이지로 이동하면 다시 서비스 페이지 접근 불가
   - 세션이 완전히 초기화되는 현상 발생

3. **서버 사이드 인증 실패**
   - 미들웨어에서 사용자 인증을 제대로 확인하지 못함
   - 페이지 새로고침 시 로그인 상태 유지 실패

---

## 🔍 원인 분석

### 1. API Route의 응답 처리 버그 (🔴 핵심 문제)

**문제 코드** (모든 인증 API에서 동일한 패턴):

```typescript
// app/api/auth/login/route.ts (line 24, 59-66)
export async function POST(request: NextRequest) {
  // response 객체 생성 (쿠키가 여기에 설정됨)
  const response = NextResponse.json({ success: false })

  const supabase = createServerClient<Database>(
    // ... 설정
    {
      cookies: {
        setAll(cookiesToSet) {
          // 쿠키가 response 객체에 설정됨
          cookiesToSet.forEach(({ name, value, options }) => {
            response.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  // ... 로그인 처리

  // ❌ 문제: 새로운 NextResponse.json()을 생성하여 반환!
  // 쿠키가 설정된 response 객체를 버리고 새로운 응답 생성
  return NextResponse.json(
    { success: true, data: result.data },
    { status: 200 }  // 쿠키가 없는 새 응답
  )
}
```

**영향받는 파일들**:
- `/app/api/auth/login/route.ts` (line 59-66)
- `/app/api/auth/signup/route.ts` (line 120-128)
- `/app/api/auth/logout/route.ts` (line 43-50)

### 2. 사용되지 않는 파일

- `lib/supabase/client.ts` 파일은 **전혀 사용되지 않음** (어디에서도 import되지 않음)
- 프로젝트는 브라우저에서 직접 Supabase 클라이언트를 사용하지 않고, API 라우트를 통해서만 처리

### 3. 미들웨어 로직 누락

`middleware.ts`에서:
- 이미 로그인한 사용자의 `/login` 접근을 허용 (line 27)
- `/login` 페이지 접근 시 `/dashboard`로 리다이렉트하는 로직 없음

---

## ✅ 해결 방안

### Phase 1: API Route 응답 처리 수정 (🔴 최우선)

#### 1.1 로그인 API 수정

**파일**: `/app/api/auth/login/route.ts`

```typescript
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { email, password } = body

    // 입력 검증...

    // ✅ 수정: 쿠키 설정을 위해 NextResponse.next() 사용
    const response = NextResponse.next()

    const supabase = createServerClient<Database>(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return request.cookies.getAll()
          },
          setAll(cookiesToSet) {
            cookiesToSet.forEach(({ name, value, options }) => {
              // response 객체에 쿠키 설정
              response.cookies.set(name, value, options)
            })
          },
        },
      },
    )

    const result = await signInUser(supabase, { email, password })

    if (!result.success) {
      // ✅ 수정: NextResponse.json()으로 응답 생성, 쿠키가 포함된 headers 전달
      return NextResponse.json(
        {
          success: false,
          data: null,
          error: result.error,
        },
        {
          status: 401,
          headers: response.headers // 핵심: 쿠키가 설정된 headers 전달
        }
      )
    }

    // ✅ 수정: NextResponse.json()으로 응답 생성, 쿠키가 포함된 headers 전달
    return NextResponse.json(
      {
        success: true,
        data: result.data,
        error: null,
      },
      {
        status: 200,
        headers: response.headers // 핵심: 쿠키가 설정된 headers 전달
      }
    )
  } catch (error) {
    console.error('Login error:', error)
    return NextResponse.json(
      {
        success: false,
        data: null,
        error: '로그인 중 오류가 발생했습니다.',
      },
      { status: 500 }
    )
  }
}
```

#### 1.2 회원가입 API 수정

**파일**: `/app/api/auth/signup/route.ts`

동일한 패턴으로 수정:
- `NextResponse.next()`로 초기 response 생성
- `NextResponse.json()`으로 최종 응답 반환
- `headers: response.headers`로 쿠키 전달

#### 1.3 로그아웃 API 수정

**파일**: `/app/api/auth/logout/route.ts`

동일한 패턴으로 수정

---

### Phase 2: 미들웨어 개선

#### 2.1 로그인 사용자의 /login 접근 차단

**파일**: `/middleware.ts`

```typescript
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // 정적 파일 및 API 경로 건너뛰기...

  // Supabase 미들웨어 클라이언트 생성
  const { supabase, response } = createMiddlewareSupabase(request)

  try {
    // 세션 확인
    await supabase.auth.getSession()

    const { data: { user } } = await supabase.auth.getUser()

    // ✅ 추가: 로그인한 사용자가 로그인/회원가입 페이지 접근 시 리다이렉트
    if (user && (pathname === '/login' || pathname === '/signup')) {
      return NextResponse.redirect(new URL('/dashboard', request.url))
    }

    // 공개 경로는 통과
    if (publicPaths.some((path) => pathname.startsWith(path))) {
      return response
    }

    // 이하 기존 로직...
  } catch (error) {
    // 에러 처리...
  }
}
```

---

### Phase 3: 불필요한 파일 제거

#### 3.1 사용되지 않는 파일 삭제

- `lib/supabase/client.ts` 파일 삭제 (전혀 사용되지 않음)

---

## 🧪 테스트 체크리스트

### 쿠키 설정 확인
- [ ] 로그인 후 개발자도구 Application → Cookies에서 `sb-` 쿠키 확인

### 세션 유지 확인
- [ ] 페이지 새로고침 후 로그인 상태 유지
- [ ] 브라우저 재시작 후 세션 유지
- [ ] 탭 간 세션 공유

### 페이지 접근 제어
- [ ] 로그인 상태에서 `/login` 접근 시 `/dashboard`로 리다이렉트
- [ ] 로그아웃 상태에서 보호된 페이지 접근 시 `/login`으로 리다이렉트

### API 동작 확인
- [ ] 로그인 API 호출 후 쿠키 생성
- [ ] 로그아웃 API 호출 후 쿠키 삭제
- [ ] 회원가입 후 적절한 응답

---

## 📝 구현 순서

1. **즉시 수정 (긴급)**
   - [ ] `/app/api/auth/login/route.ts` 응답 처리 수정
   - [ ] `/app/api/auth/signup/route.ts` 응답 처리 수정
   - [ ] `/app/api/auth/logout/route.ts` 응답 처리 수정

2. **필수 수정**
   - [ ] `middleware.ts`에 로그인 사용자 리다이렉트 로직 추가

3. **정리 작업**
   - [ ] `lib/supabase/client.ts` 파일 삭제

4. **검증**
   - [ ] 전체 테스트 시나리오 수행
   - [ ] 배포 환경에서 쿠키 설정 확인 (Secure, SameSite)

---

## ⚠️ 주의사항

### 응답 객체 처리
- **NextResponse.next()로 초기 response 생성 (쿠키 설정용)**
- **NextResponse.json()으로 최종 응답 생성 시 headers 전달 필수**
- **`headers: response.headers` 옵션으로 쿠키가 포함된 헤더 전달**

### 쿠키 옵션
- 개발 환경: `Secure: false` 허용
- 프로덕션 환경: `Secure: true`, `SameSite: 'lax'` 필수

### 마이그레이션 순서
1. API 수정 → 배포
2. 사용자에게 재로그인 안내

---

## 🔗 참고 문서

- [Supabase SSR 공식 문서](https://supabase.com/docs/guides/auth/server-side/nextjs)
- [Next.js Cookies API](https://nextjs.org/docs/app/api-reference/functions/cookies)
- 이전 계획 문서: 005, 006, 007

---

_이 문서는 쿠키 기반 인증 구현 중 발생한 문제를 해결하기 위한 긴급 조치 계획입니다._